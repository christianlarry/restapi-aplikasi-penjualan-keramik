openapi: 3.0.3
info:
  title: REST API Aplikasi Penjualan Toko Keramik
  version: 1.0.0
  description: |
    Spesifikasi OpenAPI ini digenerate berdasarkan codebase Express yang ada saat ini.

servers:
  - url: http://localhost:3000
    description: Local development

tags:
  - name: Health
  - name: Product
  - name: User
  - name: Upload

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: healthCheck
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: ok

  /api/product:
    get:
      tags: [Product]
      summary: Get products (optionally paginated)
      description: |
        Mendapatkan daftar produk dengan filter opsional.

        Jika query `pagination_page` atau `pagination_size` dikirim, response akan menyertakan objek `page`.
      operationId: getProducts
      parameters:
        - in: query
          name: search
          schema:
            type: string
          description: Search by product name/description (implementation-dependent)
        - in: query
          name: order_by
          schema:
            $ref: "#/components/schemas/ProductOrderBy"
          description: Sorting order
        - in: query
          name: pagination_page
          schema:
            type: integer
            minimum: 1
          description: Page number (enables pagination)
        - in: query
          name: pagination_size
          schema:
            type: integer
            minimum: 1
          description: Page size (enables pagination)

        - in: query
          name: design
          schema:
            type: array
            items:
              type: string
          explode: true
          style: form
          description: Filter by design (repeat query param)
        - in: query
          name: texture
          schema:
            type: array
            items:
              type: string
          explode: true
          style: form
          description: Filter by texture (repeat query param)
        - in: query
          name: finishing
          schema:
            type: array
            items:
              type: string
          explode: true
          style: form
          description: Filter by finishing (repeat query param)
        - in: query
          name: color
          schema:
            type: array
            items:
              type: string
          explode: true
          style: form
          description: Filter by color (repeat query param)
        - in: query
          name: application
          schema:
            type: array
            items:
              type: string
          explode: true
          style: form
          description: Filter by application (repeat query param)
        - in: query
          name: size
          schema:
            type: array
            items:
              type: string
              pattern: "^\\d+x\\d+$"
              example: "60x60"
          explode: true
          style: form
          description: Filter by size using format `widthxheight` (repeat query param)

        - in: query
          name: bestSeller
          schema:
            type: boolean
          description: Filter by isBestSeller
        - in: query
          name: newArrivals
          schema:
            type: boolean
          description: Filter by isNewArrivals
        - in: query
          name: discounted
          schema:
            type: boolean
          description: Filter by discounted products
      responses:
        "200":
          description: Products list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProductsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags: [Product]
      summary: Create product
      operationId: createProduct
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PostProductRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/product/filter-options:
    get:
      tags: [Product]
      summary: Get product filter options
      operationId: getProductFilterOptions
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ProductFilterOptions"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/product/{id}:
    get:
      tags: [Product]
      summary: Get product by id
      operationId: getProduct
      parameters:
        - $ref: "#/components/parameters/ProductId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      tags: [Product]
      summary: Update product (replace)
      operationId: updateProduct
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ProductId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PostProductRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags: [Product]
      summary: Delete product
      operationId: deleteProduct
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ProductId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/product/{id}/flags:
    patch:
      tags: [Product]
      summary: Update product flags
      operationId: updateProductFlags
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ProductId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProductFlagsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/product/{id}/discount:
    patch:
      tags: [Product]
      summary: Update product discount
      operationId: updateProductDiscount
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/ProductId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProductDiscountRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/product/recommendations:
    post:
      tags: [Product]
      summary: Get product recommendations by AI (Gemini)
      operationId: recommendProducts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecommendProductsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    $ref: "#/components/schemas/RecommendProductsResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          description: Too Many Requests (rate-limited)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/user/login:
    post:
      tags: [User]
      summary: Login user
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginUserRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    $ref: "#/components/schemas/LoginUserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/user/register:
    post:
      tags: [User]
      summary: Register user (protected)
      description: Endpoint ini berada di private routes, jadi membutuhkan Bearer token.
      operationId: registerUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterUserRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    $ref: "#/components/schemas/RegisterUserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/upload/product-image:
    post:
      tags: [Upload]
      summary: Upload product image
      operationId: uploadProductImage
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/UploadProductImageRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ProductId:
      name: id
      in: path
      required: true
      schema:
        type: string
        pattern: "^[a-fA-F0-9]{24}$"
      description: MongoDB ObjectId

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [message]
          properties:
            message:
              type: string
              example: Validation Error
            errors:
              type: array
              items:
                $ref: "#/components/schemas/ValidationErrorItem"

    ValidationErrorItem:
      type: object
      required: [field, message]
      properties:
        field:
          type: string
        message:
          type: string

    Pagination:
      type: object
      required: [size, total, totalPages, current]
      properties:
        size:
          type: integer
          example: 10
        total:
          type: integer
          example: 100
        totalPages:
          type: integer
          example: 10
        current:
          type: integer
          example: 1

    ProductOrderBy:
      type: string
      enum: [price_asc, price_desc, name_asc, name_desc]

    ProductSpecification:
      type: object
      required: [size, application, design, color, finishing, texture, isWaterResistant, isSlipResistant]
      properties:
        size:
          type: object
          required: [width, height]
          properties:
            width:
              type: number
              example: 60
            height:
              type: number
              example: 60
        application:
          type: array
          items:
            type: string
          example: ["Kamar Mandi"]
        design:
          type: string
          example: Modern
        color:
          type: array
          items:
            type: string
          example: ["Putih"]
        finishing:
          type: string
          example: Matte
        texture:
          type: string
          example: Glossy
        isWaterResistant:
          type: boolean
          example: true
        isSlipResistant:
          type: boolean
          example: false

    Product:
      type: object
      required: [name, specification, brand, price, tilesPerBox, createdAt, updatedAt]
      properties:
        _id:
          type: string
          description: MongoDB ObjectId
          example: 66cfa7b6b2f52c6b6d4a1111
        name:
          type: string
          example: Keramik Putih 60x60
        description:
          type: string
          nullable: true
        specification:
          $ref: "#/components/schemas/ProductSpecification"
        brand:
          type: string
          example: Roman
        price:
          type: number
          example: 120000
        discount:
          type: number
          minimum: 0
          maximum: 100
          nullable: true
          example: 10
        tilesPerBox:
          type: number
          example: 4
        isBestSeller:
          type: boolean
          example: false
        isNewArrivals:
          type: boolean
          example: false
        image:
          type: string
          nullable: true
          description: Relative path under /public
          example: uploads/images/products/keramik-60x60-1730000000000.webp
        recommended:
          type: array
          nullable: true
          items:
            type: string
          example: ["Kamar Mandi", "Dapur"]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    GetProductResponse:
      type: object
      required: [data]
      properties:
        data:
          allOf:
            - $ref: "#/components/schemas/Product"
            - type: object
              required: [finalPrice]
              properties:
                finalPrice:
                  type: number
                  example: 108000

    ProductResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/Product"

    GetProductsResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            allOf:
              - $ref: "#/components/schemas/Product"
              - type: object
                properties:
                  finalPrice:
                    type: number
                    example: 108000
        page:
          $ref: "#/components/schemas/Pagination"

    ProductFilterOption:
      type: object
      required: [label, value]
      properties:
        label:
          type: string
        value:
          type: string

    ProductFilterOptions:
      type: object
      required: [_id, type, options]
      properties:
        _id:
          type: string
          example: 66cfa7b6b2f52c6b6d4a2222
        type:
          type: string
          example: design
        options:
          type: array
          items:
            $ref: "#/components/schemas/ProductFilterOption"

    PostProductRequest:
      type: object
      required:
        - name
        - application
        - design
        - sizeWidth
        - sizeHeight
        - color
        - finishing
        - texture
        - brand
        - price
        - tilesPerBox
        - isSlipResistant
        - isWaterResistant
      properties:
        name:
          type: string
        description:
          type: string
          nullable: true
        application:
          type: array
          minItems: 1
          items:
            type: string
        design:
          type: string
        sizeWidth:
          type: number
          minimum: 0
        sizeHeight:
          type: number
          minimum: 0
        color:
          type: array
          minItems: 1
          items:
            type: string
        finishing:
          type: string
        texture:
          type: string
        brand:
          type: string
        price:
          type: number
          minimum: 0
        tilesPerBox:
          type: number
          minimum: 0
        discount:
          type: number
          minimum: 0
          maximum: 100
          nullable: true
        isSlipResistant:
          type: boolean
        isWaterResistant:
          type: boolean
        isBestSeller:
          type: boolean
          nullable: true
        isNewArrivals:
          type: boolean
          nullable: true
        recommended:
          type: array
          nullable: true
          items:
            type: string

    UpdateProductFlagsRequest:
      type: object
      properties:
        isBestSeller:
          type: boolean
          nullable: true
        isNewArrivals:
          type: boolean
          nullable: true
      additionalProperties: false

    UpdateProductDiscountRequest:
      type: object
      required: [discount]
      properties:
        discount:
          type: number
          minimum: 0
          maximum: 100

    RecommendProductsRequest:
      type: object
      required: [prompt]
      properties:
        prompt:
          type: string
          minLength: 1

    RecommendProductsResult:
      type: object
      required: [message]
      properties:
        message:
          type: string
        products:
          type: array
          nullable: true
          items:
            allOf:
              - $ref: "#/components/schemas/Product"
              - type: object
                properties:
                  finalPrice:
                    type: number

    LoginUserRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 20
        password:
          type: string
          minLength: 6

    LoginUserResponse:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: JWT access token

    RegisterUserRequest:
      type: object
      required: [firstName, lastName, username, password, role]
      properties:
        firstName:
          type: string
          minLength: 1
        lastName:
          type: string
          minLength: 1
        username:
          type: string
          minLength: 3
          maxLength: 20
        password:
          type: string
          minLength: 6
        role:
          type: string
          enum: [admin, user]

    RegisterUserResponse:
      type: object
      required: [_id, firstName, lastName, username, password, role]
      properties:
        _id:
          type: string
          description: MongoDB ObjectId
        firstName:
          type: string
        lastName:
          type: string
        username:
          type: string
        password:
          type: string
          description: Returned as-is by current implementation
        role:
          type: string
          enum: [admin, user]

    UploadProductImageRequest:
      type: object
      required: [productId, image]
      properties:
        productId:
          type: string
          pattern: "^[a-fA-F0-9]{24}$"
        image:
          type: string
          format: binary
          description: Image file (.jpg/.jpeg/.png/.webp)
